import { storage } from "./storage";
import { geminiService } from "./gemini-service";
import { whatsAppSender } from "./whatsapp-sender";

interface WhatsiPlusMessage {
  id: string;
  type: string;
  from: string;
  to: string;
  date: string;
  message: string;
}

interface WhatsiPlusResponse {
  count: number;
  pageCount: number;
  page: string;
  data: WhatsiPlusMessage[];
}

class WhatsAppMessageService {
  private intervalId: NodeJS.Timeout | null = null;
  private isRunning = false;
  private lastFetchTime: Date | null = null;

  async start() {
    if (this.isRunning) {
      console.log("ğŸ”„ Ø³Ø±ÙˆÛŒØ³ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÙˆØ§ØªØ³â€ŒØ§Ù¾ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª");
      return;
    }

    console.log("ğŸš€ Ø´Ø±ÙˆØ¹ Ø³Ø±ÙˆÛŒØ³ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÙˆØ§ØªØ³â€ŒØ§Ù¾...");
    this.isRunning = true;
    
    // Ø§Ø¬Ø±Ø§ÛŒ ÙÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø±
    await this.fetchMessages();
    
    // ØªÙ†Ø¸ÛŒÙ… interval Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ø± 5 Ø«Ø§Ù†ÛŒÙ‡
    this.intervalId = setInterval(async () => {
      await this.fetchMessages();
    }, 5000);
  }

  stop() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
    this.isRunning = false;
    console.log("ğŸ›‘ Ø³Ø±ÙˆÛŒØ³ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÙˆØ§ØªØ³â€ŒØ§Ù¾ Ù…ØªÙˆÙ‚Ù Ø´Ø¯");
  }

  async fetchMessages() {
    try {
      // Ø¯Ø±ÛŒØ§ÙØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ§ØªØ³â€ŒØ§Ù¾
      const settings = await storage.getWhatsappSettings();
      
      if (!settings || !settings.token || !settings.isEnabled) {
        console.log("âš ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ§ØªØ³â€ŒØ§Ù¾ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª ÛŒØ§ ØªÙˆÚ©Ù† Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª");
        if (!settings) console.log("   - ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª");
        if (settings && !settings.token) console.log("   - ØªÙˆÚ©Ù† Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª");
        if (settings && !settings.isEnabled) console.log("   - Ø³Ø±ÙˆÛŒØ³ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª");
        return;
      }

      console.log(`ğŸ”„ Ú†Ú© Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯...`);

      // Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø§Ø² WhatsiPlus API Ø¨Ø§ timeout Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
      
      const response = await fetch(`https://api.whatsiplus.com/receivedMessages/${settings.token}?page=1`, {
        method: 'GET',
        signal: controller.signal,
        headers: {
          'User-Agent': 'WhatsApp-Service/1.0',
          'Accept': 'application/json',
          'Cache-Control': 'no-cache'
        }
      });
      
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        console.error("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø§Ø² WhatsiPlus:", response.status, response.statusText);
        return;
      }

      const data: WhatsiPlusResponse = await response.json();
      
      if (!data.data || data.data.length === 0) {
        // console.log("ğŸ“­ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª");
        return;
      }

      let newMessagesCount = 0;

      // Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
      for (const message of data.data) {
        try {
          // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ù¾ÛŒØ§Ù… Ù‚Ø¨Ù„Ø§Ù‹ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
          const existingMessage = await storage.getReceivedMessageByWhatsiPlusId(message.id);
          
          if (!existingMessage) {
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ÛŒ Ú©Ù‡ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ù‡Ø³ØªÙ†Ø¯ (Ø§Ø¯Ù…ÛŒÙ† ÛŒØ§ Ø³Ø·Ø­ 1)
            const users = await storage.getAllUsers();
            const authorizedUsers = users.filter(user => user.role === 'admin' || user.role === 'user_level_1');

            // Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú©Ø§Ø±Ø¨Ø± Ù…Ø¬Ø§Ø²
            let savedMessageId: string | null = null;
            for (const user of authorizedUsers) {
              const savedMessage = await storage.createReceivedMessage({
                userId: user.id,
                whatsiPlusId: message.id,
                sender: message.from,
                message: message.message,
                status: "Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯Ù‡",
                originalDate: message.date
              });
              if (!savedMessageId) savedMessageId = savedMessage.id;
            }

            // Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø§ Gemini AI
            if (savedMessageId && geminiService.isActive()) {
              await this.handleAutoResponse(message.from, message.message, savedMessageId, authorizedUsers[0].id);
            }
            
            newMessagesCount++;
          }
        } catch (error) {
          console.error("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù…:", error);
        }
      }

      if (newMessagesCount > 0) {
        console.log(`ğŸ“¨ ${newMessagesCount} Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² ÙˆØ§ØªØ³â€ŒØ§Ù¾ Ø¯Ø±ÛŒØ§ÙØª Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`);
        this.lastFetchTime = new Date();
      }

    } catch (error: any) {
      if (error.name === 'AbortError') {
        console.error("â±ï¸ Timeout: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø§Ù†ØªØ¸Ø§Ø± Ø·ÙˆÙ„ Ú©Ø´ÛŒØ¯");
      } else {
        console.error("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÙˆØ§ØªØ³â€ŒØ§Ù¾:", error.message || error);
      }
    }
  }

  async handleAutoResponse(sender: string, incomingMessage: string, messageId: string, userId: string) {
    try {
      console.log(`ğŸ¤– Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ù¾Ø§Ø³Ø® Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù… Ø§Ø² ${sender}...`);
      
      // ØªÙˆÙ„ÛŒØ¯ Ù¾Ø§Ø³Ø® Ø¨Ø§ Gemini AI
      const aiResponse = await geminiService.generateResponse(incomingMessage);
      
      // Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®
      const sendSuccess = await whatsAppSender.sendMessage(sender, aiResponse, userId);
      
      if (sendSuccess) {
        // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡
        const users = await storage.getAllUsers();
        const authorizedUsers = users.filter(user => user.role === 'admin' || user.role === 'user_level_1');
        
        for (const user of authorizedUsers) {
          const userMessages = await storage.getReceivedMessagesByUser(user.id);
          const userMessage = userMessages.find(msg => msg.whatsiPlusId === messageId);
          if (userMessage) {
            await storage.updateReceivedMessageStatus(userMessage.id, "Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡");
          }
        }
        
        console.log(`âœ… Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ù‡ ${sender} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ Ùˆ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø­Ø§Ù„Øª Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¯Ø±Ø¢Ù…Ø¯`);
      } else {
        console.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ù‡ ${sender}`);
      }
      
    } catch (error) {
      console.error("âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø±:", error);
    }
  }

  getStatus() {
    return {
      isRunning: this.isRunning,
      lastFetchTime: this.lastFetchTime,
      geminiActive: geminiService.isActive()
    };
  }
}

// Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù…ÙˆÙ†Ù‡ Ø³ÛŒÙ†Ú¯Ù„ØªÙˆÙ†
export const whatsAppMessageService = new WhatsAppMessageService();